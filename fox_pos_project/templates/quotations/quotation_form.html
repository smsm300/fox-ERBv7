{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <form method="post">
        {% csrf_token %}
        
        <div class="row">
            <!-- بيانات العرض -->
            <div class="col-md-4">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">بيانات العرض</h6>
                    </div>
                    <div class="card-body">
                        {{ form.quotation_number|as_crispy_field }}
                        {{ form.customer|as_crispy_field }}
                        {{ form.valid_until|as_crispy_field }}
                        {{ form.notes|as_crispy_field }}
                    </div>
                </div>
            </div>

            <!-- أصناف العرض -->
            <div class="col-md-8">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">الأصناف</h6>
                    </div>
                    <div class="card-body">
                        {{ formset.management_form }}
                        <div id="items-container">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th style="width: 40%">المنتج</th>
                                        <th style="width: 20%">الكمية</th>
                                        <th style="width: 20%">السعر</th>
                                        <th style="width: 15%">الإجمالي</th>
                                        <th style="width: 5%"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item_form in formset %}
                                    <tr class="item-row">
                                        <td>
                                            {{ item_form.id }}
                                            {{ item_form.product }}
                                        </td>
                                        <td>{{ item_form.quantity }}</td>
                                        <td>{{ item_form.unit_price }}</td>
                                        <td>
                                            <input type="text" class="form-control item-total" readonly>
                                        </td>
                                        <td>
                                            {% if formset.can_delete %}
                                                {{ item_form.DELETE }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6"></div>
                            <div class="col-md-6">
                                <table class="table table-bordered">
                                    <tr>
                                        <th>الإجمالي الكلي:</th>
                                        <td><span id="grand-total">0.00</span></td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> حفظ العرض
                            </button>
                            <a href="{% url 'quotations:quotation_list' %}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times"></i> إلغاء
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Calculate totals
    function calculateTotals() {
        let grandTotal = 0;
        const rows = document.querySelectorAll('.item-row');
        
        rows.forEach(row => {
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const total = quantity * price;
            
            row.querySelector('.item-total').value = total.toFixed(2);
            grandTotal += total;
        });
        
        document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
    }

    // Bind events
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('quantity-input') || e.target.classList.contains('price-input')) {
            calculateTotals();
        }
    });

    calculateTotals();
});
</script>
{% endblock %}

{% extends 'base.html' %}

{% block extra_css %}
<style>
    .product-card {
        cursor: pointer;
        transition: transform 0.2s;
        height: 100%;
    }
    .product-card:hover {
        transform: scale(1.02);
        border-color: var(--accent-color);
    }
    .product-img {
        height: 120px;
        object-fit: cover;
        width: 100%;
    }
    .pos-left {
        height: calc(100vh - 100px);
        overflow-y: auto;
    }
    .pos-right {
        height: calc(100vh - 100px);
        display: flex;
        flex-direction: column;
    }
    .cart-items {
        flex-grow: 1;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        background: white;
    }
    .cart-footer {
        background: #f8f9fa;
        padding: 15px;
        border-top: 2px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Left Side: Products -->
    <div class="col-md-7 pos-left">
        <div class="card mb-3">
            <div class="card-body p-2">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                    <input type="text" id="barcode_input" class="form-control" placeholder="امسح الباركود أو ابحث..." autofocus>
                    <button class="btn btn-primary" type="button" id="search_btn">بحث</button>
                </div>
            </div>
        </div>

        <div class="row row-cols-1 row-cols-md-3 g-3" id="products_grid">
            <!-- Products will be loaded here -->
        </div>
    </div>

    <!-- Right Side: Cart -->
    <div class="col-md-5 pos-right">
        <div class="card h-100">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-shopping-cart"></i> سلة المشتريات</h5>
                <div>
                    <select id="customer_select" class="form-select form-select-sm" style="width: 200px;">
                        <option value="">اختر العميل...</option>
                        {% for customer in customers %}
                            <option value="{{ customer.customer_id }}">{{ customer.customer_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="cart-items p-0">
                <table class="table table-striped table-hover mb-0 text-center">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>المنتج</th>
                            <th>الكمية</th>
                            <th>السعر</th>
                            <th>الإجمالي</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="cart_body">
                        <!-- Cart Items -->
                    </tbody>
                </table>
            </div>

            <div class="cart-footer">
                <div class="row mb-2">
                    <div class="col-6">الإجمالي الفرعي:</div>
                    <div class="col-6 text-end fw-bold" id="subtotal_display">0.00</div>
                </div>
                <div class="row mb-2">
                    <div class="col-6">الضريبة (14%):</div>
                    <div class="col-6 text-end text-danger" id="tax_display">0.00</div>
                </div>
                <div class="row mb-3">
                    <div class="col-6 h4">الإجمالي النهائي:</div>
                    <div class="col-6 text-end h4 text-success" id="total_display">0.00</div>
                </div>
                <button class="btn btn-success w-100 py-3 fw-bold" onclick="processCheckout()">
                    <i class="fas fa-money-bill-wave"></i> إتمام الدفع (F9)
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">إتمام عملية البيع</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 text-center">
                    <h3>المبلغ المطلوب: <span id="modal_total_amount" class="text-success">0.00</span></h3>
                </div>
                <div class="mb-3">
                    <label class="form-label">طريقة الدفع</label>
                    <select class="form-select" id="payment_method">
                        <option value="cash">نقدي (Cash)</option>
                        <option value="wallet">محفظة إلكترونية</option>
                        <option value="instapay">InstaPay</option>
                        <option value="credit">آجل (ديون)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">المبلغ المدفوع</label>
                    <input type="number" class="form-control form-control-lg" id="paid_amount" step="0.01">
                </div>
                <div class="mb-3">
                    <label class="form-label">المتبقي</label>
                    <input type="text" class="form-control" id="remaining_amount" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-success" id="confirm_payment_btn">تأكيد وطباعة</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let cart = [];
    let allProducts = [];

    $(document).ready(function() {
        loadProducts();

        // Barcode Listener
        $('#barcode_input').on('keypress', function(e) {
            if(e.which == 13) {
                searchAndAddProduct($(this).val());
                $(this).val('');
            }
        });

        // Search Button
        $('#search_btn').click(function() {
            searchAndAddProduct($('#barcode_input').val());
            $('#barcode_input').val('');
        });

        // Paid Amount Calculation
        $('#paid_amount').on('input', function() {
            let total = parseFloat($('#modal_total_amount').text());
            let paid = parseFloat($(this).val()) || 0;
            $('#remaining_amount').val((paid - total).toFixed(2));
        });

        // Confirm Payment
        $('#confirm_payment_btn').click(function() {
            submitInvoice();
        });
    });

    function loadProducts() {
        $.get('{% url "sales:api_products" %}', function(data) {
            allProducts = data;
            renderProducts(data);
        });
    }

    function renderProducts(products) {
        let html = '';
        products.forEach(p => {
            let img = p.product_image ? p.product_image : 'https://via.placeholder.com/150?text=No+Image';
            html += `
                <div class="col">
                    <div class="card product-card" onclick="addToCart(${p.product_id})">
                        <img src="${img}" class="card-img-top product-img" alt="${p.product_name}">
                        <div class="card-body text-center p-2">
                            <h6 class="card-title small mb-1">${p.product_name}</h6>
                            <div class="fw-bold text-primary">${p.selling_price} ج.م</div>
                        </div>
                    </div>
                </div>
            `;
        });
        $('#products_grid').html(html);
    }

    function searchAndAddProduct(query) {
        if(!query) return;
        let product = allProducts.find(p => p.barcode === query || p.product_code === query);
        if(product) {
            addToCart(product.product_id);
        } else {
            // Try fuzzy search by name
            let filtered = allProducts.filter(p => p.product_name.includes(query));
            if(filtered.length === 1) {
                addToCart(filtered[0].product_id);
            } else if(filtered.length > 1) {
                renderProducts(filtered);
            } else {
                alert('المنتج غير موجود');
            }
        }
    }

    function addToCart(productId) {
        let product = allProducts.find(p => p.product_id === productId);
        if(!product) return;

        let existingItem = cart.find(i => i.product_id === productId);
        if(existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({
                product_id: product.product_id,
                name: product.product_name,
                price: parseFloat(product.selling_price),
                quantity: 1
            });
        }
        updateCartDisplay();
    }

    function updateCartDisplay() {
        let html = '';
        let subtotal = 0;

        cart.forEach((item, index) => {
            let total = item.quantity * item.price;
            subtotal += total;
            html += `
                <tr>
                    <td class="text-start small">${item.name}</td>
                    <td style="width: 100px;">
                        <input type="number" class="form-control form-control-sm text-center" 
                               value="${item.quantity}" min="1" 
                               onchange="updateQuantity(${index}, this.value)">
                    </td>
                    <td>${item.price}</td>
                    <td>${total.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm py-0" onclick="removeFromCart(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>
            `;
        });

        $('#cart_body').html(html);
        
        let tax = 0; // 0% tax for now based on prompt implicit requirements, or can be 14%
        // Prompt says "tax_amount" in DB. Let's assume 0 for now or configurable.
        // Let's set tax to 0 for simplicity unless configured.
        
        $('#subtotal_display').text(subtotal.toFixed(2));
        $('#tax_display').text(tax.toFixed(2));
        $('#total_display').text((subtotal + tax).toFixed(2));
    }

    function updateQuantity(index, value) {
        if(value < 1) return;
        cart[index].quantity = parseFloat(value);
        updateCartDisplay();
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCartDisplay();
    }

    function processCheckout() {
        if(cart.length === 0) {
            alert('السلة فارغة');
            return;
        }
        let total = $('#total_display').text();
        $('#modal_total_amount').text(total);
        $('#paid_amount').val(total);
        $('#remaining_amount').val('0.00');
        
        let myModal = new bootstrap.Modal(document.getElementById('checkoutModal'));
        myModal.show();
    }

    function submitInvoice() {
        let customerId = $('#customer_select').val();
        if(!customerId) {
            alert('يرجى اختيار العميل');
            return;
        }

        let data = {
            customer_id: customerId,
            items: cart,
            payment_method: $('#payment_method').val(),
            paid_amount: $('#paid_amount').val()
        };

        $.ajax({
            url: '{% url "sales:api_create_invoice" %}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            success: function(response) {
                if(response.success) {
                    alert('تم حفظ الفاتورة بنجاح: ' + response.invoice_number);
                    location.reload();
                } else {
                    alert('خطأ: ' + response.error);
                }
            },
            error: function() {
                alert('حدث خطأ في الاتصال');
            }
        });
    }
</script>
{% endblock %}
